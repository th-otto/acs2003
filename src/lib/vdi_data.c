/******************************************************************************/
/*                                                                            */
/*    ACS               Application Construction System                       */
/*    DESCRIPTION:      Line-A support                                        */
/*                                                                            */
/* (c) 1991-2004 Stefan Bachert, Oliver Michalak, Martin Elsaesser            */
/* (c) 2022 Thorsten Otto                                                     */
/******************************************************************************/

#include "acs_i.h"
#ifdef __PUREC__
#include <linea.h>
#else
#include <acslinea.h>
#endif

LINEA *Linea;
VDIESC *Vdiesc;
FONTS *Fonts;
LINEA_FUNP *Linea_funp;

static RGB1000 const vdi_color[256] = {
	{ 0x03e8, 0x03e8, 0x03e8 },
	{ 0x0000, 0x0000, 0x0000 },
	{ 0x03b5, 0x0000, 0x0000 },
	{ 0x0000, 0x0386, 0x0000 },
	{ 0x0000, 0x0000, 0x03b5 },
	{ 0x0066, 0x031c, 0x02dd },
	{ 0x03e8, 0x03e8, 0x0000 },
	{ 0x0386, 0x00c8, 0x0258 },
	{ 0x0353, 0x0353, 0x0353 },
	{ 0x01f6, 0x01f6, 0x01f6 },
	{ 0x01f6, 0x0000, 0x0000 },
	{ 0x0000, 0x01f6, 0x0000 },
	{ 0x0000, 0x0000, 0x01f6 },
	{ 0x0000, 0x01f6, 0x01f6 },
	{ 0x02ca, 0x027b, 0x00e0 },
	{ 0x01f6, 0x0000, 0x01f6 },
	{ 0x0000, 0x0000, 0x00c8 },
	{ 0x0000, 0x0000, 0x0190 },
	{ 0x0000, 0x0000, 0x0258 },
	{ 0x0000, 0x0000, 0x0320 },
	{ 0x0000, 0x0000, 0x03e8 },
	{ 0x0000, 0x00c8, 0x0000 },
	{ 0x0000, 0x00c8, 0x00c8 },
	{ 0x0000, 0x00c8, 0x0190 },
	{ 0x0000, 0x00c8, 0x0258 },
	{ 0x0000, 0x00c8, 0x0320 },
	{ 0x0000, 0x00c8, 0x03e8 },
	{ 0x0000, 0x0190, 0x0000 },
	{ 0x0000, 0x0190, 0x00c8 },
	{ 0x0000, 0x0190, 0x0190 },
	{ 0x0000, 0x0190, 0x0258 },
	{ 0x0000, 0x0190, 0x0320 },
	{ 0x0000, 0x0190, 0x03e8 },
	{ 0x0000, 0x0258, 0x0000 },
	{ 0x0000, 0x0258, 0x00c8 },
	{ 0x0000, 0x0258, 0x0190 },
	{ 0x0000, 0x0258, 0x0258 },
	{ 0x0000, 0x0258, 0x0320 },
	{ 0x0000, 0x0258, 0x03e8 },
	{ 0x0000, 0x0320, 0x0000 },
	{ 0x0000, 0x0320, 0x00c8 },
	{ 0x0000, 0x0320, 0x0190 },
	{ 0x0000, 0x0320, 0x0258 },
	{ 0x0000, 0x0320, 0x0320 },
	{ 0x0000, 0x0320, 0x03e8 },
	{ 0x0000, 0x03e8, 0x0000 },
	{ 0x0000, 0x03e8, 0x00c8 },
	{ 0x0000, 0x03e8, 0x0190 },
	{ 0x0000, 0x03e8, 0x0258 },
	{ 0x0000, 0x03e8, 0x0320 },
	{ 0x0000, 0x03e8, 0x03e8 },
	{ 0x00c8, 0x0000, 0x0000 },
	{ 0x00c8, 0x0000, 0x00c8 },
	{ 0x00c8, 0x0000, 0x0190 },
	{ 0x00c8, 0x0000, 0x0258 },
	{ 0x00c8, 0x0000, 0x0320 },
	{ 0x00c8, 0x0000, 0x03e8 },
	{ 0x00c8, 0x00c8, 0x0000 },
	{ 0x00c8, 0x00c8, 0x00c8 },
	{ 0x00c8, 0x00c8, 0x0190 },
	{ 0x0000, 0x0000, 0x02f1 },
	{ 0x00c8, 0x00c8, 0x0320 },
	{ 0x00c8, 0x00c8, 0x03e8 },
	{ 0x00c8, 0x0190, 0x0000 },
	{ 0x00c8, 0x0190, 0x00c8 },
	{ 0x00c8, 0x0190, 0x0190 },
	{ 0x00c8, 0x0190, 0x0258 },
	{ 0x00c8, 0x0190, 0x0320 },
	{ 0x00c8, 0x0190, 0x03e8 },
	{ 0x00c8, 0x0258, 0x0000 },
	{ 0x00c8, 0x0258, 0x00c8 },
	{ 0x00c8, 0x0258, 0x0190 },
	{ 0x00c8, 0x0258, 0x0258 },
	{ 0x00c8, 0x0258, 0x0320 },
	{ 0x00c8, 0x0258, 0x03e8 },
	{ 0x00c8, 0x0320, 0x0000 },
	{ 0x00c8, 0x0320, 0x00c8 },
	{ 0x00c8, 0x0320, 0x0190 },
	{ 0x00c8, 0x0320, 0x0258 },
	{ 0x00c8, 0x0320, 0x0320 },
	{ 0x00c8, 0x0320, 0x03e8 },
	{ 0x00c8, 0x03e8, 0x0000 },
	{ 0x00c8, 0x03e8, 0x00c8 },
	{ 0x00c8, 0x03e8, 0x0190 },
	{ 0x00c8, 0x03e8, 0x0258 },
	{ 0x00c8, 0x03e8, 0x0320 },
	{ 0x00c8, 0x03e8, 0x03e8 },
	{ 0x0190, 0x0000, 0x0000 },
	{ 0x0190, 0x0000, 0x00c8 },
	{ 0x0190, 0x0000, 0x0190 },
	{ 0x0190, 0x0000, 0x0258 },
	{ 0x0190, 0x0000, 0x0320 },
	{ 0x0190, 0x0000, 0x03e8 },
	{ 0x0190, 0x00c8, 0x0000 },
	{ 0x0190, 0x00c8, 0x00c8 },
	{ 0x0190, 0x00c8, 0x0190 },
	{ 0x0190, 0x00c8, 0x0258 },
	{ 0x0190, 0x00c8, 0x0320 },
	{ 0x0190, 0x00c8, 0x03e8 },
	{ 0x0190, 0x0190, 0x0000 },
	{ 0x0190, 0x0190, 0x00c8 },
	{ 0x0190, 0x0190, 0x0190 },
	{ 0x0190, 0x0190, 0x0258 },
	{ 0x0190, 0x0190, 0x0320 },
	{ 0x0190, 0x0190, 0x03e8 },
	{ 0x0190, 0x0258, 0x0000 },
	{ 0x0190, 0x0258, 0x00c8 },
	{ 0x0190, 0x0258, 0x0190 },
	{ 0x0190, 0x0258, 0x0258 },
	{ 0x0190, 0x0258, 0x0320 },
	{ 0x0190, 0x0258, 0x03e8 },
	{ 0x0190, 0x0320, 0x0000 },
	{ 0x0190, 0x0320, 0x00c8 },
	{ 0x0190, 0x0320, 0x0190 },
	{ 0x0190, 0x0320, 0x0258 },
	{ 0x0190, 0x0320, 0x0320 },
	{ 0x0190, 0x0320, 0x03e8 },
	{ 0x0190, 0x03e8, 0x0000 },
	{ 0x0190, 0x03e8, 0x00c8 },
	{ 0x0190, 0x03e8, 0x0190 },
	{ 0x0190, 0x03e8, 0x0258 },
	{ 0x0190, 0x03e8, 0x0320 },
	{ 0x0190, 0x03e8, 0x03e8 },
	{ 0x0258, 0x0000, 0x0000 },
	{ 0x0258, 0x0000, 0x00c8 },
	{ 0x0258, 0x0000, 0x0190 },
	{ 0x0258, 0x0000, 0x0258 },
	{ 0x0258, 0x0000, 0x0320 },
	{ 0x0258, 0x0000, 0x03e8 },
	{ 0x0258, 0x00c8, 0x0000 },
	{ 0x0258, 0x00c8, 0x00c8 },
	{ 0x0258, 0x00c8, 0x0190 },
	{ 0x0258, 0x00c8, 0x0258 },
	{ 0x0258, 0x00c8, 0x0320 },
	{ 0x0258, 0x00c8, 0x03e8 },
	{ 0x0258, 0x0190, 0x0000 },
	{ 0x0258, 0x0190, 0x00c8 },
	{ 0x0258, 0x0190, 0x0190 },
	{ 0x0258, 0x0190, 0x0258 },
	{ 0x0258, 0x0190, 0x0320 },
	{ 0x0258, 0x0190, 0x03e8 },
	{ 0x0258, 0x0258, 0x0000 },
	{ 0x0258, 0x0258, 0x00c8 },
	{ 0x0258, 0x0258, 0x0190 },
	{ 0x0258, 0x0258, 0x0258 },
	{ 0x0258, 0x0258, 0x0320 },
	{ 0x0258, 0x0258, 0x03e8 },
	{ 0x0258, 0x0320, 0x0000 },
	{ 0x0258, 0x0320, 0x00c8 },
	{ 0x0258, 0x0320, 0x0190 },
	{ 0x0258, 0x0320, 0x0258 },
	{ 0x0258, 0x0320, 0x0320 },
	{ 0x0258, 0x0320, 0x03e8 },
	{ 0x0258, 0x03e8, 0x0000 },
	{ 0x0258, 0x03e8, 0x00c8 },
	{ 0x0258, 0x03e8, 0x0190 },
	{ 0x0258, 0x03e8, 0x0258 },
	{ 0x0258, 0x03e8, 0x0320 },
	{ 0x0258, 0x03e8, 0x03e8 },
	{ 0x0320, 0x0000, 0x0000 },
	{ 0x0320, 0x0000, 0x00c8 },
	{ 0x0320, 0x0000, 0x0190 },
	{ 0x0320, 0x0000, 0x0258 },
	{ 0x0320, 0x0000, 0x0320 },
	{ 0x0320, 0x0000, 0x03e8 },
	{ 0x0320, 0x00c8, 0x0000 },
	{ 0x0320, 0x00c8, 0x00c8 },
	{ 0x0320, 0x00c8, 0x0190 },
	{ 0x0320, 0x00c8, 0x0258 },
	{ 0x0320, 0x00c8, 0x0320 },
	{ 0x0320, 0x00c8, 0x03e8 },
	{ 0x0320, 0x0190, 0x0000 },
	{ 0x0320, 0x0190, 0x00c8 },
	{ 0x0320, 0x0190, 0x0190 },
	{ 0x0320, 0x0190, 0x0258 },
	{ 0x0320, 0x0190, 0x0320 },
	{ 0x0320, 0x0190, 0x03e8 },
	{ 0x0320, 0x0258, 0x0000 },
	{ 0x0320, 0x0258, 0x00c8 },
	{ 0x0320, 0x0258, 0x0190 },
	{ 0x0320, 0x0258, 0x0258 },
	{ 0x0320, 0x0258, 0x0320 },
	{ 0x0320, 0x0258, 0x03e8 },
	{ 0x0320, 0x0320, 0x0000 },
	{ 0x0320, 0x0320, 0x00c8 },
	{ 0x0320, 0x0320, 0x0190 },
	{ 0x0320, 0x0320, 0x0258 },
	{ 0x0320, 0x0320, 0x0320 },
	{ 0x0320, 0x0320, 0x03e8 },
	{ 0x0320, 0x03e8, 0x0000 },
	{ 0x0320, 0x03e8, 0x00c8 },
	{ 0x0320, 0x03e8, 0x0190 },
	{ 0x0320, 0x03e8, 0x0258 },
	{ 0x0320, 0x03e8, 0x0320 },
	{ 0x0320, 0x03e8, 0x03e8 },
	{ 0x03e8, 0x0000, 0x0000 },
	{ 0x03e8, 0x0000, 0x00c8 },
	{ 0x03e8, 0x0000, 0x0190 },
	{ 0x03e8, 0x0000, 0x0258 },
	{ 0x03e8, 0x0000, 0x0320 },
	{ 0x03e8, 0x0000, 0x03e8 },
	{ 0x03e8, 0x00c8, 0x0000 },
	{ 0x03e8, 0x00c8, 0x00c8 },
	{ 0x03e8, 0x00c8, 0x0190 },
	{ 0x03e8, 0x00c8, 0x0258 },
	{ 0x03e8, 0x00c8, 0x0320 },
	{ 0x03e8, 0x00c8, 0x03e8 },
	{ 0x03e8, 0x0190, 0x0000 },
	{ 0x03e8, 0x0190, 0x00c8 },
	{ 0x03e8, 0x0190, 0x0190 },
	{ 0x03e8, 0x0190, 0x0258 },
	{ 0x03e8, 0x0190, 0x0320 },
	{ 0x03e8, 0x0190, 0x03e8 },
	{ 0x03e8, 0x0258, 0x0000 },
	{ 0x03e8, 0x0258, 0x00c8 },
	{ 0x03e8, 0x0258, 0x0190 },
	{ 0x03e8, 0x0258, 0x0258 },
	{ 0x03e8, 0x0258, 0x0320 },
	{ 0x03e8, 0x0258, 0x03e8 },
	{ 0x03e8, 0x0320, 0x0000 },
	{ 0x03e8, 0x0320, 0x00c8 },
	{ 0x03e8, 0x0320, 0x0190 },
	{ 0x03e8, 0x0320, 0x0258 },
	{ 0x03e8, 0x0320, 0x0320 },
	{ 0x03e8, 0x0320, 0x03e8 },
	{ 0x03e8, 0x03e8, 0x0000 },
	{ 0x03e8, 0x03e8, 0x00c8 },
	{ 0x03e8, 0x03e8, 0x0190 },
	{ 0x03e8, 0x03e8, 0x0258 },
	{ 0x03e8, 0x03e8, 0x0320 },
	{ 0x03b5, 0x0000, 0x0000 },
	{ 0x0386, 0x0000, 0x0000 },
	{ 0x02f1, 0x0000, 0x0000 },
	{ 0x02be, 0x0000, 0x0000 },
	{ 0x01f6, 0x0000, 0x0000 },
	{ 0x012e, 0x0000, 0x0000 },
	{ 0x0066, 0x0000, 0x0000 },
	{ 0x0000, 0x03b5, 0x0000 },
	{ 0x0000, 0x0386, 0x0000 },
	{ 0x0000, 0x02f1, 0x0000 },
	{ 0x0000, 0x02be, 0x0000 },
	{ 0x0000, 0x01f6, 0x0000 },
	{ 0x0000, 0x012e, 0x0000 },
	{ 0x0000, 0x0066, 0x0000 },
	{ 0x0000, 0x0000, 0x0066 },
	{ 0x0000, 0x0000, 0x012e },
	{ 0x0000, 0x0000, 0x01f6 },
	{ 0x0000, 0x0000, 0x02be },
	{ 0x00c8, 0x00c8, 0x0258 },
	{ 0x0000, 0x0000, 0x0386 },
	{ 0x03b5, 0x03b5, 0x03b5 },
	{ 0x0386, 0x0386, 0x0386 },
	{ 0x02f1, 0x02f1, 0x02f1 },
	{ 0x02be, 0x02be, 0x02be },
	{ 0x012e, 0x012e, 0x012e },
	{ 0x0066, 0x0066, 0x0066 }
};

/******************************************************************************/
/* -------------------------------------------------------------------------- */
/******************************************************************************/

const RGB1000 *Avdi_getRGB(int16 index)
{
	if (index >= 0 && index < 256)
		return &vdi_color[index];
	else
		return NULL;
}

/* -------------------------------------------------------------------------- */

#ifndef __PUREC__

#ifdef __mcoldfire__

#define PUSH_SP(regs,size)						\
	"lea	%%sp@(-" #size "),%%sp\n\t"					\
	"movml	" regs ",%%sp@\n\t"

#define POP_SP(regs,size)						\
	"movml	%%sp@," regs "\n\t"					\
	"lea	%%sp@(" #size "),%%sp\n\t"

#else

#define PUSH_SP(regs,size)						\
	"movml	" regs ",%%sp@-\n\t"

#define POP_SP(regs,size)						\
	"movml	%%sp@+," regs "\n\t"

#endif

#ifdef __mcoldfire__
	/*
	 * On ColdFire V4e, the standard Line A opcodes
	 * conflict with some valid MAC instructions.
	 * Fortunately, the following range is always invalid
	 * and triggers the standard Line A exception.
	 * The ColdFire OS will keep only the last 4 bits
	 */
	#define LINEA_OPCODE_BASE 0xa920
#else
	#define LINEA_OPCODE_BASE 0xa000
#endif
	#define ASM_LINEA3(opcode) ".word	" #opcode
	#define ASM_LINEA2(opcode) ASM_LINEA3(opcode)
	#define ASM_LINEA(n) ASM_LINEA2(LINEA_OPCODE_BASE+n)


void ACSInitLineA(void)
{
#ifdef __GNUC__
	register LINEA *__xaline __asm__ ("a0");
	register FONTS *__xfonts __asm__ ("a1");
	register LINEA_FUNP *__xfuncs __asm__ ("a2");

	__asm__ volatile
        (
		ASM_LINEA(0x0)
        : "=g"(__xaline), "=g"(__xfonts), "=g"(__xfuncs)  /* outputs */
        :                                                 /* inputs  */
        : __CLOBBER_RETURN("a0") __CLOBBER_RETURN("a1") __CLOBBER_RETURN("a2") "d0", "d1", "d2", "cc"       /* clobbered regs */
	  AND_MEMORY
        );

	Linea = __xaline;
	Fonts = __xfonts;
	Linea_funp = __xfuncs;
	Vdiesc = (VDIESC *)__xaline - 1;
#endif
}

#endif /* __PUREC__ */
